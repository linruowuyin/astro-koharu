---
interface Props {
  encryptedContent: string;
}
const { encryptedContent } = Astro.props;
---

<div id="password-protection" class="my-8 p-10 text-center bg-zinc-50/50 dark:bg-zinc-900/30 rounded-3xl border border-dashed border-zinc-200 dark:border-zinc-800 backdrop-blur-sm" data-encrypted={encryptedContent}>
  <div class="flex flex-col items-center gap-5">
    <div class="p-4 bg-primary/10 rounded-full text-primary animate-pulse">
      <svg width="32" height="32" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zM9 6c0-1.66 1.34-3 3-3s3 1.34 3 3v2H9V6z" fill="currentColor"></path></svg>
    </div>
    <div class="space-y-1">
      <h2 class="text-xl font-bold">此内容受密码保护</h2>
      <p class="text-sm text-muted-foreground">请输入正确的密码以解锁阅读全文</p>
    </div>
    <div class="flex w-full max-w-sm items-center space-x-2 mt-2">
      <input type="password" id="password-input" placeholder="输入密码..." class="flex h-11 w-full rounded-xl border border-zinc-200 dark:border-zinc-700 bg-background px-4 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary" />
      <button id="unlock-button" class="inline-flex items-center justify-center rounded-xl bg-primary px-6 py-2 text-sm font-medium text-primary-foreground h-11">解锁</button>
    </div>
    <p id="error-message" class="text-xs text-red-500 h-4 mt-1"></p>
  </div>
</div>

<div id="decrypted-content" style="display: none;" class="animate-in fade-in slide-in-from-bottom-4 duration-700 prose dark:prose-invert max-w-none"></div>

<script>
  import CryptoJS from "crypto-js";
  import { marked } from "marked";

  const container = document.getElementById("password-protection");
  const passwordInput = document.getElementById("password-input") as HTMLInputElement;
  const unlockButton = document.getElementById("unlock-button");
  const errorMessage = document.getElementById("error-message");
  const decryptedContainer = document.getElementById("decrypted-content");
  const encryptedData = container?.getAttribute("data-encrypted") || "";

  async function handleUnlock() {
    const password = passwordInput?.value;
    if (!password) return;

    try {
      const bytes = CryptoJS.AES.decrypt(encryptedData, password);
      const decryptedText = bytes.toString(CryptoJS.enc.Utf8);

      if (decryptedText.startsWith("VERIFY:")) {
        const rawMarkdown = decryptedText.replace("VERIFY:", "");
        const htmlContent = await marked.parse(rawMarkdown);
        
        if (container && decryptedContainer) {
          container.style.display = "none";
          decryptedContainer.innerHTML = htmlContent;
          decryptedContainer.style.display = "block";
          
          // 解锁后如果 URL 有 hash（点击目录后进来的），尝试跳转
          if (window.location.hash) {
            const targetId = decodeURIComponent(window.location.hash.substring(1));
            const targetElement = document.getElementById(targetId);
            if (targetElement) targetElement.scrollIntoView({ behavior: 'smooth' });
          }

          window.dispatchEvent(new Event('content-updated'));
        }
      } else {
        if (errorMessage) errorMessage.innerText = "密码错误";
      }
    } catch (e) {
      if (errorMessage) errorMessage.innerText = "解密失败";
    }
  }

  unlockButton?.addEventListener("click", handleUnlock);
  passwordInput?.addEventListener("keypress", (e) => { if (e.key === "Enter") handleUnlock(); });
</script>