---
import CustomContent from '@components/common/CustomContent.astro';
import HomeSider from '@components/layout/HomeSider.astro';
import SummaryPanel, { type SummarySource } from '@components/post/SummaryPanel';
import Cover from '@components/ui/cover/Cover.astro';
import { HomeSiderType } from '@constants/enum';
import { CONTENT_PADDING } from '@constants/layout';
import { siteConfig } from '@constants/site-config';
import Layout from '@layouts/Layout.astro';
import TwoColumnLayout from '@layouts/TwoColumnLayout.astro';
import { buildCategoryPath, getCategoryArr, getPostDescription, getPostSummary, getSortedPosts } from '@lib/content';
import { formatForSeo } from '@lib/date';
import { encodeSlug } from '@lib/route';
import { getOgImageUrl } from '@lib/seo/og-image';
import { Icon } from 'astro-icon/components';
import { Comment } from '@/components/comment';
import EditButton from '@/components/EditButton';
import { extractTextFromMarkdown } from '@/lib/sanitize';

import PasswordProtection from '@components/post/PasswordProtection.astro';
import CryptoJS from "crypto-js";

export async function getStaticPaths() {
  const postCollections = await getSortedPosts();

  return postCollections.map((post) => {
    const link = post.data?.link ?? post.slug;
    return {
      params: { slug: encodeSlug(link) },
      props: { post, postId: post.id },
    };
  });
}
const { post, postId } = Astro.props;
const { Content, headings } = await post.render(); 
const { title, categories = [], tags = [], date } = post?.data ?? {};

const isEncrypted = post.data.encrypted && post.data.password;
let encryptedContent = "";
if (isEncrypted) {
  encryptedContent = CryptoJS.AES.encrypt(
    "VERIFY:" + post.body, 
    String(post.data.password)
  ).toString();
}

const finalDescription = getPostDescription(post);
const ogImage = getOgImageUrl(post?.data.cover, Astro.site);

const jsonLd = {
  '@context': 'https://schema.org',
  '@type': 'BlogPosting',
  headline: title,
  description: finalDescription,
  keywords: categories?.length ? tags.concat(categories[0]) : tags,
  author: { '@type': 'Person', name: siteConfig.author ?? siteConfig.name, url: Astro.site },
  datePublished: formatForSeo(date),
  ...(post.data.updated && { dateModified: formatForSeo(post.data.updated) }),
  ...(ogImage && { image: ogImage }),
  mainEntityOfPage: Astro.url.href,
};

const categoryArr = getCategoryArr(categories?.[0]);
const categoryStr = categoryArr?.length ? ` | ${categoryArr.join(' / ')}` : '';

const breadcrumbCategories = [];
if (categoryArr?.length) {
  for (let i = 0; i < categoryArr.length; i++) {
    const partialCategories = categoryArr.slice(0, i + 1);
    const link = buildCategoryPath(partialCategories);
    breadcrumbCategories.push({ name: categoryArr[i], link: link });
  }
}

const homeName = siteConfig.breadcrumbHome || '首页';
const postSlug = post.data?.link ?? post.slug;
let summaryText: string | null = null;
let summarySource: SummarySource | null = null;

if (post.data.description) {
  summaryText = post.data.description;
  summarySource = 'description';
} else {
  const aiSummary = getPostSummary(postSlug);
  if (aiSummary) {
    summaryText = aiSummary;
    summarySource = 'ai';
  } else {
    summaryText = extractTextFromMarkdown(post.body, 200);
    summarySource = 'auto';
  }
}
---

<Layout
  title={`${post.data.title}${categoryStr} | ${siteConfig.title}`}
  description={finalDescription}
  siderType={HomeSiderType.POST}
  post={post}
>
  <TwoColumnLayout post={post}>
    <Cover slot="cover" data={post} />
    {/* 目录不再受限，始终渲染原始 headings */}
    <HomeSider slot="sider" type={HomeSiderType.POST} post={post} headings={headings} />
    
    <div class={`shadow-box bg-gradient-start flex flex-col gap-2 ${CONTENT_PADDING.standard}`}>
      <nav class="text-muted-foreground flex items-center justify-between gap-2 text-sm">
        <div class="flex items-center gap-2">
          <div class="flex items-center gap-1">
            <Icon name="fa6-solid:house-chimney" class="h-4 w-4" />
            <a href="/"><span class="hover:text-blue transition-colors duration-300">{homeName}</span></a>
          </div>
          {breadcrumbCategories.map((category) => (
            <>
              <Icon name="ri:arrow-right-s-line" class="text-muted-foreground/60 h-4 w-4" />
              <a href={category.link} class="hover:text-blue transition-colors duration-300">{category.name}</a>
            </>
          ))}
        </div>
      </nav>

      <article class="prose md:prose-sm dark:prose-invert">
        {isEncrypted ? (
          <PasswordProtection encryptedContent={encryptedContent} />
        ) : (
          <CustomContent Content={Content} />
        )}
      </article>
      <Comment />
    </div>
  </TwoColumnLayout>
</Layout>